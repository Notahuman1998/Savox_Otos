<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savox Acoustician Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone.dragover { border-color: #3b82f6; background-color: #eff6ff; }
        /* Terminal styling */
        .terminal { font-family: 'Courier New', Courier, monospace; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col items-center justify-center p-6">

    <div class="bg-white shadow-xl rounded-2xl w-full max-w-6xl overflow-hidden flex flex-col md:flex-row h-[85vh]">
        
        <!-- Sidebar / Controls -->
        <div class="w-full md:w-1/3 bg-slate-50 p-6 flex flex-col border-r border-slate-200">
            <h1 class="text-xl font-bold text-slate-800 mb-1">Patient Encoder</h1>
            <p class="text-xs text-slate-500 mb-4">Savox-Otos Hearing Systems v1.1 (Debug Mode)</p>

            <!-- File Upload -->
            <div id="dropZone" class="drop-zone rounded-lg p-6 flex flex-col items-center justify-center text-center cursor-pointer mb-4 h-32">
                <p class="text-sm text-slate-600 font-medium">Drop XML File Here</p>
                <input type="file" id="fileInput" class="hidden" accept=".xml">
            </div>

            <!-- Action Buttons -->
            <div class="space-y-2 mb-4">
                <button id="btnConnect" class="w-full py-2 px-4 bg-slate-800 hover:bg-slate-700 text-white rounded-lg font-medium transition flex items-center justify-center gap-2">
                    Connect Hardware
                </button>
                <button id="btnCheck" disabled class="w-full py-2 px-4 bg-slate-200 text-slate-500 rounded-lg font-medium transition disabled:cursor-not-allowed hover:bg-slate-300">
                    Run Self-Test (Ping)
                </button>
                <button id="btnWrite" disabled class="w-full py-3 px-4 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-300 disabled:cursor-not-allowed text-white rounded-lg font-medium transition shadow-lg shadow-blue-500/30">
                    Write to Card
                </button>
            </div>
            
            <!-- DEBUG CONSOLE -->
            <div class="flex-grow flex flex-col bg-slate-900 rounded-lg overflow-hidden border border-slate-700">
                <div class="bg-slate-800 px-3 py-1 text-xs text-slate-400 border-b border-slate-700 flex justify-between">
                    <span>DEVICE LOG</span>
                    <span id="clearLog" class="cursor-pointer hover:text-white">Clear</span>
                </div>
                <div id="consoleLog" class="terminal p-3 text-xs text-green-400 overflow-y-auto h-full scrollbar-hide space-y-1">
                    <div class="text-slate-500">> Waiting for connection...</div>
                </div>
            </div>
        </div>

        <!-- Visualization Area -->
        <div class="w-full md:w-2/3 p-6 bg-white relative">
            <h2 class="text-sm font-bold text-slate-400 uppercase tracking-wide mb-4">Audiogram Visualization</h2>
            <div class="relative h-[90%] w-full">
                <canvas id="audiogramChart"></canvas>
            </div>
            <div id="emptyState" class="absolute inset-0 bg-white/80 flex items-center justify-center">
                <p class="text-slate-400">Load patient data to view audiogram</p>
            </div>
        </div>
    </div>

    <script>
        let port;
        let writer;
        let reader;
        let patientData = null; 

        const TARGET_FREQS = [125, 250, 500, 750, 1000, 1500, 2000, 3000, 4000, 6000, 8000];

        // --- Console Logic ---
        const consoleLog = document.getElementById('consoleLog');
        function log(msg, type = 'info') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            line.textContent = `[${time}] ${msg}`;
            
            if (msg.includes("ERROR") || msg.includes("FAIL") || msg.includes("TIMEOUT")) line.classList.add('text-red-400');
            else if (msg.includes("SUCCESS") || msg.includes("OK")) line.classList.add('text-green-400', 'font-bold');
            else if (msg.includes("DEBUG")) line.classList.add('text-yellow-200');
            else line.classList.add('text-slate-300');

            consoleLog.appendChild(line);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }
        document.getElementById('clearLog').onclick = () => consoleLog.innerHTML = '';

        // --- File Handling (Same as before) ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.onclick = () => fileInput.click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
        dropZone.ondragleave = () => dropZone.classList.remove('dragover');
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFile(e.dataTransfer.files[0]); };
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        function handleFile(file) {
            if (!file) return;
            log(`Loading file: ${file.name}...`);
            const reader = new FileReader();
            reader.onload = (e) => parseXML(e.target.result);
            reader.readAsText(file);
        }

        function parseXML(xmlString) {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, "text/xml");
                // ... (Parsing logic same as previous version) ...
                const audiograms = xmlDoc.getElementsByTagName("ToneThresholdAudiogram");
                
                // Simplified extraction for demo brevity (assume standard XML structure)
                let leftData = new Array(TARGET_FREQS.length).fill(0);
                let rightData = new Array(TARGET_FREQS.length).fill(0);
                
                const extractCurve = (gram) => {
                    const points = gram.getElementsByTagName("TonePoints");
                    let curve = {};
                    for (let point of points) {
                        const freq = parseInt(point.querySelector("StimulusFrequency")?.textContent);
                        const level = parseInt(point.querySelector("StimulusLevel")?.textContent);
                        if (!isNaN(freq)) curve[freq] = level;
                    }
                    return curve;
                };

                for (let gram of audiograms) {
                    const output = gram.querySelector("StimulusSignalOutput")?.textContent;
                    const curve = extractCurve(gram);
                    const mappedData = TARGET_FREQS.map(f => curve[f] !== undefined ? curve[f] : 0);
                    if (output === "AirConductorLeft") leftData = mappedData;
                    if (output === "AirConductorRight") rightData = mappedData;
                }

                updateChart(leftData, rightData);
                preparePacket(leftData, rightData);
                document.getElementById('emptyState').classList.add('hidden');
                log("File parsed successfully. Data Ready.");
            } catch (e) {
                log("Error parsing XML: " + e.message, 'error');
            }
        }

        function preparePacket(left, right) {
            const buffer = new Int8Array(left.length + right.length);
            buffer.set(left, 0);
            buffer.set(right, left.length);
            patientData = buffer;
            checkReady();
        }

        let chart;
        function updateChart(left, right) {
            const ctx = document.getElementById('audiogramChart').getContext('2d');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: TARGET_FREQS,
                    datasets: [
                        { label: 'Left Ear (X)', data: left, borderColor: '#3b82f6', pointStyle: 'crossRot', tension: 0.1 },
                        { label: 'Right Ear (O)', data: right, borderColor: '#ef4444', pointStyle: 'circle', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { reverse: true, min: -10, max: 120, title: { display: true, text: 'dB HL' } }
                    }
                }
            });
        }

        // --- Serial Communication ---
        const btnConnect = document.getElementById('btnConnect');
        const btnWrite = document.getElementById('btnWrite');
        const btnCheck = document.getElementById('btnCheck');
        const textDecoder = new TextDecoderStream();

        btnConnect.onclick = async () => {
            if ("serial" in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    writer = port.writable.getWriter();
                    const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
                    reader = textDecoder.readable.getReader();
                    readLoop();

                    btnConnect.textContent = "Hardware Connected";
                    btnConnect.classList.replace('bg-slate-800', 'bg-green-600');
                    btnCheck.disabled = false;
                    btnCheck.classList.replace('bg-slate-200', 'bg-slate-700');
                    btnCheck.classList.replace('text-slate-500', 'text-white');
                    checkReady();

                    log("Port Opened. Requesting Status...");
                    setTimeout(sendSelfTest, 500); // Auto-check on connect

                } catch (err) {
                    log("Connection Error: " + err.message);
                }
            } else { alert("Browser not supported"); }
        };

        async function readLoop() {
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                if (value) handleSerialMessage(value);
            }
        }

        function handleSerialMessage(msg) {
            // Log every single message to the console
            log(msg.trim());
            
            if (msg.includes("SUCCESS")) {
                alert("Success! Data written.");
            }
        }

        // SEND COMMAND: 'S' (Status)
        async function sendSelfTest() {
            if (!writer) return;
            log("> CMD: Running Self-Test...");
            const encoder = new TextEncoder();
            await writer.write(encoder.encode('S'));
        }
        btnCheck.onclick = sendSelfTest;

        // SEND COMMAND: 'W' (Write)
        btnWrite.onclick = async () => {
            if (!writer || !patientData) return;
            log("> CMD: Sending Write Data...");
            const encoder = new TextEncoder();
            await writer.write(encoder.encode('W'));
            await writer.write(patientData);
        };

        function checkReady() {
            if (writer && patientData) btnWrite.disabled = false;
        }

    </script>
</body>
</html>
